<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STILL ALIVE - Viral Photobooth</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #00f2ff; --dark: #0d0221; }
        body { margin: 0; font-family: 'Courier New', Courier, monospace; background: var(--dark); color: white; overflow-x: hidden; text-align: center; }
        
        #main-booth { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #video-container { position: relative; width: 320px; height: 240px; border: 4px solid var(--primary); border-radius: 10px; overflow: hidden; background: #000; transform: scaleX(-1); }
        video { width: 100%; height: 100%; object-fit: cover; }
        #flash { position: absolute; top:0; left:0; width:100%; height:100%; background:white; display:none; z-index: 10; }
        
        .btn-capture { margin-top: 20px; padding: 15px 40px; font-size: 18px; font-weight: bold; color: var(--dark); background: var(--primary); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px var(--primary); transition: 0.3s; }
        .btn-capture:hover { transform: scale(1.1); box-shadow: 0 0 30px var(--primary); }

        #selector-ui { display: none; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: #1a1a3a; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); background: #252550; }
        .preview { width: 100%; height: 120px; border-radius: 4px; margin-bottom: 5px; }

        #qr-screen { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #qrcode { background: white; padding: 20px; border-radius: 10px; }
        
        .brand { font-size: 24px; font-weight: bold; margin-bottom: 20px; letter-spacing: 5px; color: var(--primary); }
        
        /* Music Floating Icon */
        #music-ctrl { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: var(--dark); padding: 10px; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 200; box-shadow: 0 0 10px var(--primary); }
    </style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="https://www.bensound.com/bensound-music/bensound-buddy.mp3" type="audio/mpeg">
    </audio>

    <div id="main-booth">
        <div class="brand">STILL ALIVE</div>
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
            <div id="flash"></div>
        </div>
        <button class="btn-capture" onclick="takeAction()">START CAPTURE</button>
        <p id="timer" style="font-size: 40px; margin-top: 20px;"></p>
    </div>

    <div id="selector-ui">
        <h2 style="color: var(--primary);">SELECT YOUR MOOD</h2>
        <div class="grid" id="grid"></div>
    </div>

    <div id="qr-screen">
        <h2 style="color: var(--primary);">YEAY! SCAN QR TO DOWNLOAD</h2>
        <div id="qrcode"></div>
        <button class="btn-capture" onclick="location.reload()" style="margin-top: 30px;">TAKE AGAIN</button>
    </div>

    <div id="music-ctrl" onclick="toggleMusic()">üéµ</div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const bgMusic = document.getElementById('bg-music');
        let snaps = [];

        navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s);

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playCekrek() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'white' || 'noise';
            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function playPop() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function toggleMusic() {
            if (bgMusic.paused) {
                bgMusic.play();
                document.getElementById('music-ctrl').innerText = '‚è∏Ô∏è';
            } else {
                bgMusic.pause();
                document.getElementById('music-ctrl').innerText = 'üéµ';
            }
        }

        async function takeAction() {
            // Musik otomatis main pas mulai foto
            bgMusic.play().catch(() => console.log("Music ready"));
            document.getElementById('music-ctrl').innerText = '‚è∏Ô∏è';

            snaps = [];
            const timerDisplay = document.getElementById('timer');
            for(let i=0; i<4; i++) {
                let countdown = 3;
                while(countdown > 0) {
                    timerDisplay.innerText = countdown;
                    await new Promise(r => setTimeout(r, 1000));
                    countdown--;
                }
                timerDisplay.innerText = "CHEESE!";
                playCekrek();
                document.getElementById('flash').style.display='block';
                setTimeout(()=>document.getElementById('flash').style.display='none', 100);
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                ctx.save(); ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0); ctx.restore();
                snaps.push(canvas.toDataURL('image/jpeg', 0.8));
                await new Promise(r => setTimeout(r, 500));
            }
            timerDisplay.innerText = "";
            showGallery();
        }

        function showGallery() {
            document.getElementById('main-booth').style.display = 'none';
            document.getElementById('selector-ui').style.display = 'block';
            const g = document.getElementById('grid');
            const moods = [
                { n: 'KUROMI', bg: '#2D033B', tx: '#C147E9', char: 'üòà', mode: 'cyber' },
                { n: 'MELODY', bg: '#FFC1CC', tx: '#FB607F', char: 'üéÄ', mode: 'gemoy' },
                { n: 'VINTAGE', bg: '#353935', tx: '#E9FF70', char: 'üìº', mode: 'analog' },
                { n: 'LUXURY', bg: '#000000', tx: '#FFFFFF', char: '‚ú®', mode: 'magazine' }
            ];
            for(let i=0; i<1000; i++) {
                const mood = moods[i % moods.length];
                const h = (i * 137.5) % 360;
                const finalBg = (i < 4) ? mood.bg : `hsl(${h}, 60%, 90%)`;
                const finalTx = (i < 4) ? mood.tx : `hsl(${h}, 70%, 30%)`;
                const d = document.createElement('div');
                d.className = 'card';
                d.innerHTML = `<div class="preview" style="background:${finalBg}; border:2px solid ${finalTx}; display:flex; align-items:center; justify-content:center; color:${finalTx}; font-size:12px;">${mood.char}</div><small>#${i+1}</small>`;
                d.onclick = () => { playPop(); savePDF(finalBg, finalTx, mood.mode, mood.char); };
                g.appendChild(d);
            }
        }

        function savePDF(bg, tx, mode, char) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', [50, 150]);
            doc.setFillColor(bg); doc.rect(0, 0, 50, 150, 'F');
            doc.setTextColor(tx);
            doc.setFont("courier", "bold"); doc.setFontSize(10);
            doc.text("STILL ALIVE", 25, 12, {align:'center'});
            let y = 20;
            snaps.forEach((img, i) => {
                const w = 38, h = 26, x = 6;
                if(mode === 'analog') { doc.setFillColor(0); doc.rect(2, y+10, 2, 4, 'F'); doc.rect(46, y+10, 2, 4, 'F'); }
                doc.addImage(img, 'JPEG', x, y, w, h);
                doc.setDrawColor(tx); doc.rect(x, y, w, h, 'S');
                y += h + 3;
                if(i === 1) { doc.setFontSize(14); doc.text(char, 25, y + 4, {align:'center'}); y += 8; }
            });
            doc.setFillColor(tx);
            for(let j=0; j<25; j++) { doc.rect(8 + (j*1.4), 142, Math.random()*1.2, 4, 'F'); }
            doc.output('blob').then(b => {
                const fd = new FormData(); fd.append('file', b, 'stillalive.pdf');
                fetch('https://file.io', { method: 'POST', body: fd })
                .then(r => r.json()).then(d => {
                    document.getElementById('qr-screen').style.display='flex';
                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById("qrcode"), { text: d.link, width: 200, height: 200 });
                });
            });
        }
    </script>
</body>
</html>
